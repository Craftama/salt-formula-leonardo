{%- set service = salt['pillar.get']('supervisor:server:service:'+service_name) %}
{%- set app = salt['pillar.get']('leonardo:server:app:'+service.name) %}

{% if app.server_engine is not defined or app.server_engine == 'gunicorn' %}

[program:{{ service.type }}_{{ service.name }}]
command=/srv/leonardo/sites/{{ service.name }}/bin/gunicorn_start
stdout_logfile=/srv/leonardo/sites/{{ service.name }}/logs/access.log 
stderr_logfile=/srv/leonardo/sites/{{ service.name }}/error.log
user=leonardo
autostart=true
autorestart=true

{% elif app.server_engine is defined or app.server_engine == 'daphne' %}

[program:{{ service.type }}_{{ service.name }}_web_interface]
directory=/srv/leonardo/sites/{{ service.name }}
command=/srv/leonardo/sites/{{ service.name }}/bin/daphne -p {{ app.bind.port }} -b {{ app.bind.get("host", 'localhost') }} asgi:channel_layer
stdout_logfile=/srv/leonardo/sites/{{ service.name }}/logs/access.log 
stderr_logfile=/srv/leonardo/sites/{{ service.name }}/error.log
user=leonardo
autostart=true
autorestart=true

[program:{{ service.type }}_{{ service.name }}_web_worker]
command=/srv/leonardo/sites/{{ service.name }}/bin/python /srv/leonardo/sites/{{ service.name }}/manage.py runworker
stdout_logfile=/srv/leonardo/sites/{{ service.name }}/logs/access.log 
stderr_logfile=/srv/leonardo/sites/{{ service.name }}/error.log
user=leonardo
autostart=true
autorestart=true

{% endif %}

{% if app.worker is defined and app.worker %}

[program:{{ service.type }}_{{ service.name }}_worker]
directory=/srv/leonardo/sites/{{ service.name }}
command=/srv/leonardo/sites/{{ service.name }}/bin/python /srv/leonardo/sites/{{ service.name }}/manage.py celery worker -B -E -Q {{ service.name }} --hostname={{ service.name }}@{{ pillar.linux.system.name }}.{{ pillar.linux.system.domain }}
stdout_logfile=/srv/leonardo/sites/{{ service.name }}/logs/worker.log 
stderr_logfile=/srv/leonardo/sites/{{ service.name }}/worker_error.log
user=leonardo
autostart=true
autorestart=true

#[program:{{ service.type }}_{{ service.name }}_celerycam]
#directory=/srv/leonardo/sites/{{ service.name }}
#command=/srv/leonardo/sites/{{ service.name }}/bin/python /srv/leonardo/sites/{{ service.name }}/manage.py celerycam
#stdout_logfile=/srv/leonardo/sites/{{ service.name }}/logs/celerycam.log 
#stderr_logfile=/srv/leonardo/sites/{{ service.name }}/celerycam_error.log
#user=leonardo
#autostart=true
#autorestart=true

{% endif %}
